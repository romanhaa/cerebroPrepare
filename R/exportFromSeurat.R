#' Export Seurat object to Cerebro.
#'
#' This function allows to export a Seurat object to visualize in Cerebro.
#' @param object Seurat object.
#' @param experiment_name Experiment name.
#' @param organism Organism, e.g. hg (human), mm (mouse), etc.
#' @param column_sample Column in object@meta.data that contains information about sample; defaults to "sample".
#' @param column_cluster Column in object@meta.data that contains information about cluster; defaults to "cluster".
#' @param column_nUMI Column in object@meta.data that contains information about number of transcripts per cell; defaults to "nUMI".
#' @param column_nGene Column in object@meta.data that contains information about number of expressed genes per cell; defaults to "nGene".
#' @param column_cell_cycle_regev Optional column in object@meta.data that contains information about cell cycle phase based on Regev method (default of Seurat); defaults to NULL.
#' @param column_cell_cycle_cyclone Optional column in object@meta.data that contains information about cell cycle phase based on Cyclone method; defaults to NULL.
#' @param add_all_meta_data If set to TRUE, all further meta data columns will be extracted as well.
#' @keywords seurat cerebro
#' @export
#' @examples
#' exportFromSeurat(object = seurat, experiment_name = "PDX_patient_A", organism = "hg")

exportFromSeurat <- function(
  object,
  experiment_name,
  organism,
  column_sample = "sample",
  column_cluster = "cluster",
  column_nUMI = "nUMI",
  column_nGene = "nGene",
  column_cell_cycle_regev = NULL,
  column_cell_cycle_cyclone = NULL,
  add_all_meta_data = TRUE
) {
  ##--------------------------------------------------------------------------##
  ## load required packages
  ##--------------------------------------------------------------------------##
  # Seurat
  if (!requireNamespace("Seurat", quietly = TRUE)) {
    stop(
      "Package 'Seurat' needed for this function to work. Please install it.",
      call. = FALSE
    )
  } else {
    require("Seurat")
  }
  # dplyr
  if (!requireNamespace("dplyr", quietly = TRUE)) {
    stop(
      "Package 'dplyr' needed for this function to work. Please install it.",
      call. = FALSE
    )
  } else {
    require("dplyr")
  }
  # tidyr
  if (!requireNamespace("dplyr", quietly = TRUE)) {
    stop(
      "Package 'dplyr' needed for this function to work. Please install it.",
      call. = FALSE
    )
  } else {
    require("tidyr")
  }
  ##--------------------------------------------------------------------------##
  ## colors
  ##--------------------------------------------------------------------------##
  # Dutch palette from flatuicolors.com
  colors_dutch <- c(
      "#FFC312","#C4E538","#12CBC4","#FDA7DF","#ED4C67",
      "#F79F1F","#A3CB38","#1289A7","#D980FA","#B53471",
      "#EE5A24","#009432","#0652DD","#9980FA","#833471",
      "#EA2027","#006266","#1B1464","#5758BB","#6F1E51"
    )
  # Spanish palette from flatuicolors.com
  colors_spanish <- c(
      "#40407a","#706fd3","#f7f1e3","#34ace0","#33d9b2",
      "#2c2c54","#474787","#aaa69d","#227093","#218c74",
      "#ff5252","#ff793f","#d1ccc0","#ffb142","#ffda79",
      "#b33939","#cd6133","#84817a","#cc8e35","#ccae62"
    )
  colors <- c(colors_dutch, colors_spanish)
  cell_cycle_colorset <- setNames(
    c("#45aaf2","#f1c40f","#e74c3c", "#7f8c8d"),
    c("G1","S","G2M","-")
  )
  ##--------------------------------------------------------------------------##
  ## initialize export object
  ##--------------------------------------------------------------------------##
  export <- list(
    experiment = list(
      experiment_name = experiment_name,
      organism = organism
    )
  )
  ##--------------------------------------------------------------------------##
  ## check provided parameters
  ##--------------------------------------------------------------------------##
  #
  if ( (column_sample %in% names(object@meta.data) == FALSE ) ) {
    stop("Sample column not found in meta data.", call. = FALSE)
  }
  if ( (column_cluster %in% names(object@meta.data) == FALSE ) ) {
    stop("Cluster column not found in meta data.", call. = FALSE)
  }
  if ( (column_nUMI %in% names(object@meta.data) == FALSE ) ) {
    stop(
      "Column with number of transcripts per cell not found in meta data.",
      call. = FALSE
    )
  }
  if ( (column_nGene %in% names(object@meta.data) == FALSE ) ) {
    stop(
      "Column with number of expressed genes per cell not found in meta data.",
      call. = FALSE
    )
  }
  ##--------------------------------------------------------------------------##
  ## samples
  ##--------------------------------------------------------------------------##
  if ( is.factor(object@meta.data[[column_sample]]) ) {
    sample_names <- as.character(levels(object@meta.data[[column_sample]]))
  } else {
    sample_names <- unique(object@meta.data[[column_sample]])
  }
  export$samples <- list(
    colors = setNames(colors[ 1:length(sample_names) ], sample_names),
    overview = data.frame("sample" = sample_names)
  )
  ##--------------------------------------------------------------------------##
  ## clusters
  ##--------------------------------------------------------------------------##
  if ( is.factor(object@meta.data[[column_cluster]]) ) {
    cluster_names <- as.character(levels(object@meta.data[[column_cluster]]))
  } else {
    cluster_names <- sort(unique(object@meta.data[[column_cluster]]))
  }
  export$clusters <- list(
    colors = setNames(colors[ 1:length(cluster_names) ], cluster_names),
    overview = data.frame("cluster" = cluster_names)
  )
  ##--------------------------------------------------------------------------##
  ## meta data
  ##--------------------------------------------------------------------------##
  meta_data_columns <- names(object@meta.data)
  export$cells <- data.frame(
    "sample" = as.factor(object@meta.data[[column_sample]]),
    "cluster" = as.factor(object@meta.data[[column_cluster]]),
    "nUMI" = object@meta.data[column_nUMI],
    "nGene" = object@meta.data[column_nGene]
  )
  ##--------------------------------------------------------------------------##
  ## samples by cluster
  ##--------------------------------------------------------------------------##
  export$samples$by_cluster <- export$cells %>%
    group_by(sample, cluster) %>%
    summarize(count=n()) %>%
    spread(cluster, count, fill = 0) %>%
    ungroup() %>%
    mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
    select(c("sample", "total_cell_count", everything())) %>%
    arrange(factor(sample, levels = sample_names))
  ##--------------------------------------------------------------------------##
  ## clusters by sample
  ##--------------------------------------------------------------------------##
  export$clusters$by_samples <- export$cells %>%
    group_by(cluster, sample) %>%
    summarize(count=n()) %>%
    spread(sample, count, fill = 0) %>%
    ungroup() %>%
    mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
    select(c("cluster", "total_cell_count", everything())) %>%
    arrange(factor(cluster, levels = cluster_names))
  meta_data_columns <- meta_data_columns[-which(meta_data_columns == column_sample)]
  meta_data_columns <- meta_data_columns[-which(meta_data_columns == column_cluster)]
  meta_data_columns <- meta_data_columns[-which(meta_data_columns == column_nUMI)]
  meta_data_columns <- meta_data_columns[-which(meta_data_columns == column_nGene)]
  ##--------------------------------------------------------------------------##
  ## cell cycle Seurat (if present)
  ##--------------------------------------------------------------------------##
  if ( !is.null(column_cell_cycle_regev) && column_cell_cycle_regev %in% names(object@meta.data) ) {
    export$cells$cell_cycle_Regev <- object@meta.data[[column_cell_cycle_regev]]
    # by sample
    export$samples$by_cell_cycle_Regev <- export$cells %>%
      group_by(sample, cell_cycle_Regev) %>%
      summarize(count=n()) %>%
      spread(cell_cycle_Regev, count, fill = 0) %>%
      ungroup() %>%
      mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
      select(c("sample", "total_cell_count", everything())) %>%
      arrange(factor(sample, levels = sample_names))
    # by cluster
    export$clusters$by_cell_cycle_Regev <- export$cells %>%
      group_by(cluster, cell_cycle_Regev) %>%
      summarize(count=n()) %>%
      spread(cell_cycle_Regev, count, fill = 0) %>%
      ungroup() %>%
      mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
      select(c("cluster", "total_cell_count", everything())) %>%
      arrange(factor(cluster, levels = cluster_names))
    meta_data_columns <- meta_data_columns[-which(meta_data_columns == column_cell_cycle_regev)]
  }
  ##--------------------------------------------------------------------------##
  ## cell cycle Cyclone (if present)
  ##--------------------------------------------------------------------------##
  if ( !is.null(column_cell_cycle_cyclone) && column_cell_cycle_cyclone %in% names(object@meta.data) ) {
    export$cells$cell_cycle_Cyclone <- object@meta.data[[column_cell_cycle_cyclone]]
    # by sample
    export$samples$by_cell_cycle_Cyclone <- export$cells %>%
      group_by(sample, cell_cycle_Cyclone) %>%
      summarize(count=n()) %>%
      spread(cell_cycle_Cyclone, count, fill = 0) %>%
      ungroup() %>%
      mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
      select(c("sample", "total_cell_count", everything())) %>%
      arrange(factor(sample, levels = sample_names))
    # by cluster
    export$clusters$by_cell_cycle_Cyclone <- export$cells %>%
      group_by(cluster, cell_cycle_Cyclone) %>%
      summarize(count=n()) %>%
      spread(cell_cycle_Cyclone, count, fill = 0) %>%
      ungroup() %>%
      mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
      select(c("cluster", "total_cell_count", everything())) %>%
      arrange(factor(cluster, levels = cluster_names))
    meta_data_columns <- meta_data_columns[-which(meta_data_columns == column_cell_cycle_cyclone)]
  }
  ##--------------------------------------------------------------------------##
  ## cell barcode
  ##--------------------------------------------------------------------------##
  if ( !is.null(rownames(as.data.frame(object@meta.data))) ) {
    export$cells$cell_barcode <- rownames(as.data.frame(object@meta.data))
  }
  ##--------------------------------------------------------------------------##
  ## add all other meta data if specified
  ##--------------------------------------------------------------------------##
  if ( add_all_meta_data ) {
    export$cells <- cbind(export$cells, object@meta.data[meta_data_columns])
  }
  ##--------------------------------------------------------------------------##
  ## most expressed genes
  ##--------------------------------------------------------------------------##
  if ( !is.null(object@misc$most_expressed_genes) ) {
    export$most_expressed_genes <- object@misc$most_expressed_genes
  }
  ##--------------------------------------------------------------------------##
  ## marker genes
  ##--------------------------------------------------------------------------##
  if ( !is.null(object@misc$marker_genes) ) {
    export$marker_genes <- object@misc$marker_genes
  }
  ##--------------------------------------------------------------------------##
  ## dimensional reductions
  ##--------------------------------------------------------------------------##
  export$projections <- list()
  projections_available <- names(object@dr)
  projections_available_non_pca <- projections_available[grep(projections_available, pattern = "pca", invert = TRUE)]
  if ( length(projections_available) == 0 ) {
    stop("Warning: No dimensional reductions available.", call. = FALSE)
  } else if ( length(projections_available) == 1 && projections_available_non_pca == 1 ) {
    export$projections[[projections_available]] <- as.data.frame(object@dr[[projections_available]]@cell.embeddings)[,1:2]
    print("Warning: Only PCA as dimensional reduction found, will export first and second principal components. Consider using tSNE and/or UMAP instead.")
  } else if ( length(projections_available_non_pca) > 0 ) {
    for ( i in projections_available_non_pca ) {
      export$projections[[i]] <- as.data.frame(object@dr[[i]]@cell.embeddings)
    }
  }
  ##--------------------------------------------------------------------------##
  ## cluster tree
  ##--------------------------------------------------------------------------##
  if ( !is.null(object@cluster.tree) ) {
    export$clusters$tree <- object@cluster.tree[[1]]
  }
  ##--------------------------------------------------------------------------##
  ## log-normalized expression
  ##--------------------------------------------------------------------------##
  export$expression <- object@data
  #
  return(export)
}